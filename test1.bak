// #include <cstdlib>c
#include <stdlib.h>
#include <time.h>
#include <unistd.h>
#include <stdio.h>
#include "lib/rope.h"

rope_node *read_file_to_rope(const char *filename) {
    FILE *fp = fopen(filename, "r");
    if (!fp) return NULL;

    char buffer[CHUNK_SIZE];
    rope_node *root = NULL;

    while (!feof(fp)) {
        size_t n = fread(buffer, 1, CHUNK_SIZE, fp);
        if (n == 0) break;

        rope_node *leaf = make_leaf(buffer);
        if (!root) root = leaf;
        else root = concat(root, leaf); // simplistic balancing
    }

    fclose(fp);
    return root;
}

int main(){
  FILE *f = fopen("test2.txt", "r");
    if(!f){
        perror("failed to open file!");
        return 1;
    }
    char buffer[CHUNK_SIZE + 1];
    size_t bytes_read;


    rope_node **leaves;
    leaves = NULL;
    int cap = 0,count = 0;
    clock_t start,end;
    double cpu_time_used;
    start = clock();
    while ((bytes_read = fread(buffer, 1, CHUNK_SIZE, f)) > 0) {
        buffer[bytes_read] = '\0';
        if(count >= cap){
            cap = (cap == 0) ? 8 : cap * 2;
            leaves = realloc(leaves, cap * sizeof(*leaves));
        }
        leaves[count++] = make_leaf(buffer);
    }
    // sleep(5);
    mem_for_special mem;
    init_mem_f_s(&mem, 1);
    end = clock();
    
    rope_node *root = build_balanced_rope(leaves, count);
    cpu_time_used = ((double)(end-start)) / CLOCKS_PER_SEC;
    printf("time taken: %f seconds\n",cpu_time_used);
    free(leaves);
    int depth = count_depth(root);
    // free_internal(root);
    free_ropes(root,&mem);
    free_mem(&mem);
    fclose(f);
    // free(mem.arr);
    // printf("%d %lu\n",depth,root->line_count);
    return 0;
}
